<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aegis Crypto Core - WASM Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }

    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fafafa;
    }

    .test-title {
      font-weight: bold;
      color: #34495e;
      margin-bottom: 10px;
    }

    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 3px;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    .status {
      font-weight: bold;
      margin: 20px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üß™ Aegis Crypto Core - WASM Test</h1>

    <div class="status" id="status">Loading WASM module...</div>

    <div class="test-section">
      <div class="test-title">1. WASM Module Loading</div>
      <div id="wasm-load-result" class="test-result info">Testing...</div>
    </div>

    <div class="test-section">
      <div class="test-title">2. Hash Functions</div>
      <button onclick="testHashFunctions()" id="hash-btn" disabled>Test Hash Functions</button>
      <div id="hash-result" class="test-result info">Click button to test</div>
    </div>

    <div class="test-section">
      <div class="test-title">3. Utility Functions</div>
      <button onclick="testUtilityFunctions()" id="util-btn" disabled>Test Utility Functions</button>
      <div id="util-result" class="test-result info">Click button to test</div>
    </div>

    <div class="test-section">
      <div class="test-title">4. WASM Memory Verification</div>
      <div id="memory-result" class="test-result info">Checking memory configuration...</div>
    </div>
  </div>

  <script type="module">
    import init, { sha3_256_hash, blake3_hash, hex_to_bytes, bytes_to_hex } from './pkg/aegis_crypto_core.js';

    let wasmModule = null;

    async function loadWasm() {
      try {
        console.log('Loading WASM module...');
        wasmModule = await init();
        console.log('WASM module loaded successfully');

        document.getElementById('status').textContent = '‚úÖ WASM module loaded successfully!';
        document.getElementById('wasm-load-result').innerHTML = '<span class="success">‚úÖ WASM module loaded and initialized</span>';

        // Enable test buttons
        document.getElementById('hash-btn').disabled = false;
        document.getElementById('util-btn').disabled = false;

        // Check memory configuration
        checkMemoryConfiguration();

      } catch (error) {
        console.error('Failed to load WASM module:', error);
        document.getElementById('status').textContent = '‚ùå Failed to load WASM module';
        document.getElementById('wasm-load-result').innerHTML = `<span class="error">‚ùå Failed to load WASM module: ${error.message}</span>`;
      }
    }

    function checkMemoryConfiguration() {
      try {
        // Check if we can access the WASM memory
        if (wasmModule && wasmModule.memory) {
          const memory = wasmModule.memory;
          const memorySize = memory.buffer.byteLength;
          const memorySizeMB = (memorySize / (1024 * 1024)).toFixed(2);

          document.getElementById('memory-result').innerHTML = `
                        <span class="success">‚úÖ Memory accessible</span><br>
                        <strong>Memory Size:</strong> ${memorySizeMB} MB (${memorySize} bytes)<br>
                        <strong>Memory Pages:</strong> ${memorySize / 65536} (64KB each)
                    `;
        } else {
          document.getElementById('memory-result').innerHTML = '<span class="error">‚ùå Memory not accessible</span>';
        }
      } catch (error) {
        document.getElementById('memory-result').innerHTML = `<span class="error">‚ùå Memory check failed: ${error.message}</span>`;
      }
    }

    window.testHashFunctions = function () {
      try {
        const testData = new Uint8Array([72, 101, 108, 108, 111, 44, 32, 65, 101, 103, 105, 115, 32, 67, 114, 121, 112, 116, 111, 33]); // "Hello, Aegis Crypto!"

        // Test SHA3-256
        const sha3Hash = sha3_256_hash(testData);
        const sha3Hex = bytes_to_hex(sha3Hash);

        // Test Blake3
        const blake3Hash = blake3_hash(testData);
        const blake3Hex = bytes_to_hex(blake3Hash);

        // Verify consistency
        const sha3Hash2 = sha3_256_hash(testData);
        const blake3Hash2 = blake3_hash(testData);

        const sha3Consistent = sha3Hash.length === sha3Hash2.length &&
          sha3Hash.every((val, idx) => val === sha3Hash2[idx]);
        const blake3Consistent = blake3Hash.length === blake3Hash2.length &&
          blake3Hash.every((val, idx) => val === blake3Hash2[idx]);

        document.getElementById('hash-result').innerHTML = `
                    <span class="success">‚úÖ Hash functions working</span><br>
                    <strong>SHA3-256:</strong> ${sha3Hex}<br>
                    <strong>Blake3:</strong> ${blake3Hex}<br>
                    <strong>SHA3 Consistency:</strong> ${sha3Consistent ? '‚úÖ' : '‚ùå'}<br>
                    <strong>Blake3 Consistency:</strong> ${blake3Consistent ? '‚úÖ' : '‚ùå'}
                `;

      } catch (error) {
        document.getElementById('hash-result').innerHTML = `<span class="error">‚ùå Hash test failed: ${error.message}</span>`;
      }
    };

    window.testUtilityFunctions = function () {
      try {
        const testHex = "48656c6c6f2c2041656769732043727970746f21";
        const bytes = hex_to_bytes(testHex);
        const backToHex = bytes_to_hex(bytes);

        const conversionWorks = testHex.toLowerCase() === backToHex.toLowerCase();

        document.getElementById('util-result').innerHTML = `
                    <span class="success">‚úÖ Utility functions working</span><br>
                    <strong>Original Hex:</strong> ${testHex}<br>
                    <strong>Converted Back:</strong> ${backToHex}<br>
                    <strong>Conversion Works:</strong> ${conversionWorks ? '‚úÖ' : '‚ùå'}
                `;

      } catch (error) {
        document.getElementById('util-result').innerHTML = `<span class="error">‚ùå Utility test failed: ${error.message}</span>`;
      }
    };

    // Load WASM module when page loads
    loadWasm();
  </script>
</body>

</html>
