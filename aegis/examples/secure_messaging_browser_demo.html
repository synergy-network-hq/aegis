<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Messaging Browser Demo</title>
</head>
<body>
    <h1>Secure Messaging (Browser) Demo</h1>
    <p>Open the browser console to see the secure messaging output.</p>

    <script type="module">
        import init, {
            kyber_keygen,
            kyber_encapsulate,
            kyber_decapsulate,
            dilithium_keygen,
            dilithium_sign,
            dilithium_verify,
            falcon_keygen,
            falcon_sign,
            falcon_verify,
        } from "../pkg/aegis_crypto_core.js";

        // Helper: convert an ArrayBuffer or TypedArray to hex string
        const buf2hex = (buffer) => Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, '0'))
            .join('');

        async function encryptWithAESGCM(sharedSecret, plaintext) {
            // Use the first 32 bytes of the shared secret as the AES key
            const keyMaterial = sharedSecret.slice(0, 32);
            const key = await crypto.subtle.importKey(
                'raw',
                keyMaterial,
                { name: 'AES-GCM' },
                false,
                ['encrypt', 'decrypt']
            );
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const cipherBuf = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                plaintext
            );
            return { ciphertext: new Uint8Array(cipherBuf), iv: iv };
        }

        async function decryptWithAESGCM(sharedSecret, iv, ciphertext) {
            const keyMaterial = sharedSecret.slice(0, 32);
            const key = await crypto.subtle.importKey(
                'raw',
                keyMaterial,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            const plainBuf = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                ciphertext
            );
            return new Uint8Array(plainBuf);
        }

        async function runDemo() {
            console.log('--- Secure Messaging Browser Demo ---');
            await init();
            console.log('WASM initialised');

            // Generate Kyber key pairs for Alice and Bob
            const aliceKyber = kyber_keygen();
            const bobKyber = kyber_keygen();

            // Encrypt a message from Alice to Bob
            const message = new TextEncoder().encode('Hello Bob! (from browser)');
            const encapsulated = kyber_encapsulate(bobKyber.public_key);
            const sharedSecret = encapsulated.shared_secret;
            const kemCiphertext = encapsulated.ciphertext;
            const encResult = await encryptWithAESGCM(sharedSecret, message);
            console.log('Kyber encapsulation ciphertext length:', kemCiphertext.length);
            console.log('AES-GCM IV:', buf2hex(encResult.iv));
            console.log('AES-GCM ciphertext length:', encResult.ciphertext.length);

            // Decrypt on Bob's side
            const decShared = kyber_decapsulate(bobKyber.secret_key, kemCiphertext);
            const decrypted = await decryptWithAESGCM(decShared, encResult.iv, encResult.ciphertext);
            console.log('Decrypted message:', new TextDecoder().decode(decrypted));

            // Sign and verify using Dilithium and Falcon
            const aliceDilithium = dilithium_keygen();
            const aliceFalcon = falcon_keygen();
            const signMsg = new TextEncoder().encode('Browser signature test');
            const dilithiumSig = dilithium_sign(aliceDilithium.secret_key, signMsg);
            const isDValid = dilithium_verify(aliceDilithium.public_key, signMsg, dilithiumSig);
            console.log('Dilithium signature valid:', isDValid);
            const falconSig = falcon_sign(aliceFalcon.secret_key, signMsg);
            const isFValid = falcon_verify(aliceFalcon.public_key, signMsg, falconSig);
            console.log('Falcon signature valid:', isFValid);
        }

        runDemo().catch((err) => console.error(err));
    </script>
</body>
</html>