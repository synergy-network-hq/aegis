<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aegis NIST Reference WASM Demo</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }

    h2 {
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    .section {
      margin-bottom: 30px;
    }

    .button {
      background-color: #3498db;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }

    .button:hover {
      background-color: #2980b9;
    }

    .button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }

    .success {
      color: #27ae60;
      font-weight: bold;
    }

    .error {
      color: #e74c3c;
      font-weight: bold;
    }

    .info {
      color: #3498db;
      font-weight: bold;
    }

    .log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .variant-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .variant-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
    }

    .variant-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .status {
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }

    .status.loading {
      background-color: #f39c12;
      color: white;
    }

    .status.success {
      background-color: #27ae60;
      color: white;
    }

    .status.error {
      background-color: #e74c3c;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê Aegis NIST Reference WASM Demo</h1>
    <p>This demo showcases the integration of NIST reference ML-KEM and ML-DSA implementations compiled to WebAssembly.
    </p>
  </div>

  <div class="container">
    <h2>üåê Environment Check</h2>
    <div class="section">
      <button class="button" onclick="checkEnvironment()">Check Environment</button>
      <div id="environment-status"></div>
    </div>
  </div>

  <div class="container">
    <h2>üì¶ ML-KEM Variants</h2>
    <div class="section">
      <button class="button" onclick="loadMlkemInfo()">Load ML-KEM Info</button>
      <div id="mlkem-variants" class="variant-info"></div>
    </div>

    <div class="section">
      <h3>Test ML-KEM Operations</h3>
      <select id="mlkem-variant" class="button">
        <option value="ML-KEM-512">ML-KEM-512</option>
        <option value="ML-KEM-768">ML-KEM-768</option>
        <option value="ML-KEM-1024">ML-KEM-1024</option>
      </select>
      <button class="button" onclick="testMlkem()">Test ML-KEM</button>
      <div id="mlkem-results"></div>
    </div>
  </div>

  <div class="container">
    <h2>‚úçÔ∏è ML-DSA Variants</h2>
    <div class="section">
      <button class="button" onclick="loadMldsaInfo()">Load ML-DSA Info</button>
      <div id="mldsa-variants" class="variant-info"></div>
    </div>

    <div class="section">
      <h3>Test ML-DSA Operations</h3>
      <select id="mldsa-variant" class="button">
        <option value="ML-DSA-2">ML-DSA-2</option>
        <option value="ML-DSA-3">ML-DSA-3</option>
        <option value="ML-DSA-5">ML-DSA-5</option>
        <option value="ML-DSA-2-AES">ML-DSA-2-AES</option>
        <option value="ML-DSA-3-AES">ML-DSA-3-AES</option>
        <option value="ML-DSA-5-AES">ML-DSA-5-AES</option>
      </select>
      <button class="button" onclick="testMldsa()">Test ML-DSA</button>
      <div id="mldsa-results"></div>
    </div>
  </div>

  <div class="container">
    <h2>üìã Test Log</h2>
    <div id="log" class="log"></div>
    <button class="button" onclick="clearLog()">Clear Log</button>
  </div>

  <script type="module">
    import init, {
      nistMlkemKeygen, nistMlkemEncapsulate, nistMlkemDecapsulate, nistMlkemVariants,
      nistMldsaKeygen, nistMldsaSign, nistMldsaVerify, nistMldsaVariants,
      initWasmLoader, loadMlkemModules, loadMldsaModules, isWasmSupported, getWasmInfo
    } from './pkg/aegis_crypto_core.js';

    let wasmModule = null;

    async function initializeWasm() {
      try {
        log('üöÄ Initializing Aegis WASM module...');
        wasmModule = await init();
        log('‚úÖ WASM module initialized successfully');
        return true;
      } catch (error) {
        log(`‚ùå Failed to initialize WASM module: ${error}`, 'error');
        return false;
      }
    }

    async function checkEnvironment() {
      const statusDiv = document.getElementById('environment-status');
      statusDiv.innerHTML = '<div class="status loading">Checking environment...</div>';

      try {
        if (!wasmModule) {
          const initialized = await initializeWasm();
          if (!initialized) {
            statusDiv.innerHTML = '<div class="status error">Failed to initialize WASM</div>';
            return;
          }
        }

        const wasmSupported = isWasmSupported();
        const wasmInfo = getWasmInfo();

        let statusHtml = '<div class="status success">Environment Check Complete</div>';
        statusHtml += '<div style="margin-top: 10px;">';
        statusHtml += `<p><strong>WASM Support:</strong> ${wasmSupported ? '‚úÖ Yes' : '‚ùå No'}</p>`;

        if (wasmInfo) {
          const info = wasmInfo;
          statusHtml += `<p><strong>Fetch API:</strong> ${info.fetch_supported ? '‚úÖ Yes' : '‚ùå No'}</p>`;
          statusHtml += `<p><strong>Promise Support:</strong> ${info.promise_supported ? '‚úÖ Yes' : '‚ùå No'}</p>`;
        }

        statusHtml += '</div>';
        statusDiv.innerHTML = statusHtml;

        log('‚úÖ Environment check completed successfully');
      } catch (error) {
        statusDiv.innerHTML = '<div class="status error">Environment check failed</div>';
        log(`‚ùå Environment check failed: ${error}`, 'error');
      }
    }

    async function loadMlkemInfo() {
      try {
        log('üì¶ Loading ML-KEM variants information...');
        const variants = nistMlkemVariants();
        displayVariants(variants, 'mlkem-variants', 'ML-KEM');
        log('‚úÖ ML-KEM variants loaded successfully');
      } catch (error) {
        log(`‚ùå Failed to load ML-KEM variants: ${error}`, 'error');
      }
    }

    async function loadMldsaInfo() {
      try {
        log('‚úçÔ∏è Loading ML-DSA variants information...');
        const variants = nistMldsaVariants();
        displayVariants(variants, 'mldsa-variants', 'ML-DSA');
        log('‚úÖ ML-DSA variants loaded successfully');
      } catch (error) {
        log(`‚ùå Failed to load ML-DSA variants: ${error}`, 'error');
      }
    }

    function displayVariants(variants, containerId, prefix) {
      const container = document.getElementById(containerId);
      if (!variants || !container) return;

      try {
        const variantsArray = variants;
        let html = '';

        for (let i = 0; i < variantsArray.length; i++) {
          const variant = variantsArray[i];
          if (variant) {
            const name = variant.name || `Unknown`;
            const pkLen = variant.public_key_length || 'N/A';
            const skLen = variant.secret_key_length || 'N/A';
            const ctLen = variant.ciphertext_length || variant.signature_length || 'N/A';
            const ssLen = variant.shared_secret_length || 'N/A';
            const hashFunc = variant.hash_function || 'N/A';

            html += `
                            <div class="variant-card">
                                <h3>${name}</h3>
                                <p><strong>Public Key:</strong> ${pkLen} bytes</p>
                                <p><strong>Secret Key:</strong> ${skLen} bytes</p>
                                <p><strong>${prefix === 'ML-KEM' ? 'Ciphertext' : 'Signature'}:</strong> ${ctLen} bytes</p>
                                ${prefix === 'ML-KEM' ? `<p><strong>Shared Secret:</strong> ${ssLen} bytes</p>` : ''}
                                ${prefix === 'ML-DSA' ? `<p><strong>Hash Function:</strong> ${hashFunc}</p>` : ''}
                            </div>
                        `;
          }
        }

        container.innerHTML = html;
      } catch (error) {
        log(`‚ùå Error displaying ${prefix} variants: ${error}`, 'error');
      }
    }

    async function testMlkem() {
      const variant = document.getElementById('mlkem-variant').value;
      const resultsDiv = document.getElementById('mlkem-results');

      try {
        log(`üîê Testing ML-KEM ${variant}...`);
        resultsDiv.innerHTML = '<div class="status loading">Testing ML-KEM...</div>';

        // Generate keypair
        log(`  üìù Generating keypair for ${variant}...`);
        const keypair = await nistMlkemKeygen(variant);
        log(`  ‚úÖ Keypair generated successfully`);
        log(`    Public Key: ${keypair.public_key_length()} bytes`);
        log(`    Secret Key: ${keypair.secret_key_length()} bytes`);

        // Encapsulate
        log(`  üîí Encapsulating shared secret...`);
        const encapsulated = await nistMlkemEncapsulate(variant, keypair.public_key());
        log(`  ‚úÖ Encapsulation successful`);
        log(`    Ciphertext: ${encapsulated.ciphertext_length()} bytes`);
        log(`    Shared Secret: ${encapsulated.shared_secret_length()} bytes`);

        // Decapsulate
        log(`  üîì Decapsulating shared secret...`);
        const decapsulated = await nistMlkemDecapsulate(variant, keypair.secret_key(), encapsulated.ciphertext());
        log(`  ‚úÖ Decapsulation successful`);
        log(`    Decapsulated Secret: ${decapsulated.length} bytes`);

        // Verify shared secrets match
        const originalSS = Array.from(encapsulated.shared_secret());
        const decapsulatedSS = Array.from(decapsulated);
        const secretsMatch = originalSS.length === decapsulatedSS.length &&
          originalSS.every((val, idx) => val === decapsulatedSS[idx]);

        if (secretsMatch) {
          log(`  üéâ SUCCESS: Shared secrets match!`);
          resultsDiv.innerHTML = '<div class="status success">ML-KEM test completed successfully!</div>';
        } else {
          log(`  ‚ùå FAILURE: Shared secrets do not match!`, 'error');
          resultsDiv.innerHTML = '<div class="status error">ML-KEM test failed: Shared secrets do not match</div>';
        }

      } catch (error) {
        log(`‚ùå ML-KEM test failed: ${error}`, 'error');
        resultsDiv.innerHTML = `<div class="status error">ML-KEM test failed: ${error}</div>`;
      }
    }

    async function testMldsa() {
      const variant = document.getElementById('mldsa-variant').value;
      const resultsDiv = document.getElementById('mldsa-results');

      try {
        log(`‚úçÔ∏è Testing ML-DSA ${variant}...`);
        resultsDiv.innerHTML = '<div class="status loading">Testing ML-DSA...</div>';

        // Generate keypair
        log(`  üìù Generating keypair for ${variant}...`);
        const keypair = await nistMldsaKeygen(variant);
        log(`  ‚úÖ Keypair generated successfully`);
        log(`    Public Key: ${keypair.public_key_length()} bytes`);
        log(`    Secret Key: ${keypair.secret_key_length()} bytes`);

        // Sign message
        const message = new TextEncoder().encode('Hello, Post-Quantum World!');
        log(`  ‚úçÔ∏è Signing message: "${new TextDecoder().decode(message)}"`);
        const signature = await nistMldsaSign(variant, keypair.secret_key(), message);
        log(`  ‚úÖ Message signed successfully`);
        log(`    Signature: ${signature.length} bytes`);

        // Verify signature
        log(`  üîç Verifying signature...`);
        const isValid = await nistMldsaVerify(variant, keypair.public_key(), signature, message);
        log(`  ‚úÖ Signature verification completed`);

        if (isValid) {
          log(`  üéâ SUCCESS: Signature verification passed!`);
          resultsDiv.innerHTML = '<div class="status success">ML-DSA test completed successfully!</div>';
        } else {
          log(`  ‚ùå FAILURE: Signature verification failed!`, 'error');
          resultsDiv.innerHTML = '<div class="status error">ML-DSA test failed: Signature verification failed</div>';
        }

      } catch (error) {
        log(`‚ùå ML-DSA test failed: ${error}`, 'error');
        resultsDiv.innerHTML = `<div class="status error">ML-DSA test failed: ${error}</div>`;
      }
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `[${timestamp}] ${message}`;

      if (type === 'error') {
        logEntry.className = 'error';
      } else if (type === 'success') {
        logEntry.className = 'success';
      }

      logDiv.appendChild(logEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // Initialize when page loads
    window.addEventListener('load', async () => {
      log('üåê Aegis NIST Reference WASM Demo loaded');
      log('Click "Check Environment" to begin');
    });

    // Make functions globally available
    window.checkEnvironment = checkEnvironment;
    window.loadMlkemInfo = loadMlkemInfo;
    window.loadMldsaInfo = loadMldsaInfo;
    window.testMlkem = testMlkem;
    window.testMldsa = testMldsa;
    window.clearLog = clearLog;
  </script>
</body>

</html>
